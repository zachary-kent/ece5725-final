<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">

  <title>2048</title>

  <!-- Bootstrap core CSS -->
  <link href="dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

  <!-- Custom styles for this template -->
  <link href="starter-template.css" rel="stylesheet">

  <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
  <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
  <!-- <script src="../../assets/js/ie-emulation-modes-warning.js"></script> -->

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
          aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">2048</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
          <li><a href="#obj">Project Objective</a></li>
          <li><a href="#intro">Introduction</a></li>
          <li><a href="#design">Design & Testing</a></li>
          <li><a href="#results">Results</a></li>
          <li><a href="#conclusion">Conclusion</a></li>
          <li><a href="#future">Future Work</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>

  <div class="container starter-container">

    <div class="starter-template">
      <h1>2048</h1>
      <p class="lead">May 17, 2023<br>Created by Zachary Kent (zak33) and Nadia Barakatain (nnb28)</p>
    </div>

    <hr>
    <div class="center-block">
      <iframe width="640" height="360" src="https://www.youtube.com/embed/GuM8vTq0jd4" frameborder="0"
        allowfullscreen></iframe>
      <h4 style="text-align:center;">Demonstration Video</h4>
    </div>

    <hr id="obj">

    <div class="section">
      <h2>Objective</h2>
      <p>
        We aimed to implement the classic mobile game of 2048 on the Raspberry Pi to be displayed on (and controlled by)
        the PiTFT. Further, it is clear that much of the future of embedded systems relies on cloud and IOT integration
        so that these devices can cooperate and communicate over long distances. To this end, we aimed for different
        players from arbitrary locations to compete and view each other's high scores, which would persist between
        different sessions.
      </p>
    </div>

    <hr id="intro">

    <div class="section">
      <h2>Introduction</h2>
      <p>For our final project, we decided to develop our spin on the
        classic game of 2048. In 2048, tiles labeled with powers of two are laid out on a 4 by 4 grid. You can shift all
        tiles up, down, left, or right until they collide with either another tile or the boundary of the grid. If two
        tiles labeled with the same tile collide, they are merged into a single tile, labeled with the double of the two
        individual tiles. You lose when the board fills completely with tiles and you can not make any other move to
        merge them. We aimed to implement 2048 so it was playable on the PiTFT and could be controlled using either the
        4 tactile buttons or swipes of the touchscreen. Further, we wanted the player's high score to persist across
        different sessions, and we also wanted each player to be able to view the high scores of other players playing
        on different machines. We implemented both the game logic and the GUI in Python (using the pygame library),
        while we implemented persistent high scores by recording this information in Cloud Firestore. Overall, we
        believe that we were successful in our goal of creating a fundamentally embedded system integrated with the
        cloud and IOT.
      </p>
    </div>

    <hr id='design'>

    <div class="section">
      <h2>Design & Testing</h2>
      <p>We took a top-down approach to designing our system, meaning that
        we broke larger systems into progressively smaller child systems. This allowed us to work independently on many
        aspects of the project, increasing our efficiency and the degree of “parallelism” to our workflow. Of course,
        these subsystems would eventually have to interact with each other, but we could instead “stub-in” lightweight
        interfaces between them to be implemented later. Being forced to develop these subsystems also allowed them to
        be decoupled, so that the implementation of one could be changed without affecting the other. We decided to
        break down our application into 3 smaller subsystems: the GUI, the game logic, and the backend database. We will
        now describe the design and testing of each of these subsystems in detail.
      </p>
      <h3>Game Logic</h3>
      <h4>Design</h4>
      Our game logic for 2048 needed to encapsulate the abstract logic of 2048, including the positions of different
      tiles and how they are moved/merged when the board is shifted in different directions. To this end, we created a
      class “Board” which represents an abstract square board in 2048. Although a typical 2048 board is only 4 by 4, we
      parameterized this board over its side length so we could potentially support larger boards in the future. We
      represented a board using a matrix whose entries represent the values of the corresponding tiles. Then, we added
      methods to this class representing the different actions you would perform on a board while playing the game. For
      example, we added a <code>shift</code> method that would shift the board in a given direction. This was a
      non-trivial task,
      as the semantics for shifting tiles in a different direction are somewhat contrived. Further, we did not want to
      duplicate code for shifting the board in different directions, as this would make the code more difficult to
      maintain and fragile to change; the code for shifting the board in different directions would be fundamentally
      coupled depending on the semantics we had prescribed. In order to minimize code duplication, we decided to only
      implement the logic for shifting the board left; to shift the board in other directions, we could instead rotate
      the board, shift it to the left, and rotate it back. We developed the following rules for shifting the tiles in
      different directions:
      <ul>
        <li>To shift the board up, rotate the board 90 degrees counterclockwise, shift the board left, and rotate the
          board back 90 degrees clockwise</li>
        <li>To shift the board down, rotate the board 90 degrees clockwise, shift the board left, and rotate the board
          back 90 degrees counterclockwise</li>
        <li>To shift the board right, rotate the board 180 degrees counterclockwise, shift the board left, and rotate
          the board back 180 degrees clockwise</li>
      </ul>
      <p>Then, to complete the implementation of shifting the board, all that remained was to implement the
        functionality for shifting the board left. We “reverse-engineered” the semantics of shifting a 2048 board by
        playing 2048 online and recording how different edge cases are handled. This ensured that our game logic would
        match that of the original as closely as possible. Through this testing, we determined that shifting a row of
        tiles left adheres to the following rules:</p>
      <ol>
        <li>First, move all tiles in a row left as far as possible until they are all adjacent.</li>
        <li>Merge adjacent tiles of equal value into one of double value left to right. Tiles that were already merged
          into a tile of larger value should not be merged again.</li>
      </ol>
      <p>Because every row was represented as an array of tiles, this algorithm could be implemented using a simple
        python loop where we considered adjacent tiles by inspecting tiles at indices <i>i</i> and <i>i</i> + 1 for
        <i>i</i> = 0..<i>n</i>, where <i>n</i> denotes the side length of the board. To avoid implementing tedious
        matrix rotations ourselves, we decided to represent the board using a numpy
        array, allowing us to use built-in numpy rotations. With the ability to shift a board left and rotate the board
        to an arbitrary degree, we were able to complete our implementation of <code>shift</code>.
      </p>
      <p>The other large component of the game logic included score tracking, which was also somewhat nontrivial to
        implement. Through empirical testing, we determined that every time you shift the board, your score increases by
        the sum of the tiles that are merged. In order to implement this logic, we compared the board before shifting
        and the board after shifting, flattening both into lists of tiles. Then, the score increase by shifting the
        board is equal to the sum of the tiles in the difference of the shifted board's tiles and the original board's
        tiles. This works because the only tiles that will be added to the board when shifting are those that are merged
        to create doubled tiles, and the total score increase is the sum of these merged tiles.</p>
      <p>Finally, we implemented the logic for when determining when a game has ended. After more empirical
        experimentation, we determined that you lose in 2048 when the board is full and you can make no move to merge
        any tiles. In order to compute this losing condition, we checked whether shifting the board up, down, left, and
        right resulted in no change to the board's contents. This completed our implementation of the game logic, which
        could then be accessed by the GUI using the <code>Board</code> class and its high level methods.</p>
    </div>
    <h4>Testing</h4>
    <p>Comprehensive testing was critical to ensure the correctness of both the game logic and our application as a
      whole. Uncaught bugs in the game logic code would likely bubble up into the GUI to be viewed by the player. This
      would make them very hard to diagnose, as such a bug could have originated from any of our 3 different subsystems.
    </p>
    <p>In order to ensure that this did not happen, we employed thorough unit testing of our game logic, which was very
      amenable to assertion-based testing. For example, we wrote several unit tests that asserted shifting a particular
      board configuration in a specified direction resulted in the correct output board configuration. Unit tests are
      especially useful in testing the correctness of different edge cases, many of which we considered while writing
      the logic code itself. Having a fully automated test suite further allowed us to ensure that we did not
      inadvertently introduce any regressions into our code, which would have also been difficult to spot and correct.
      We wrote the unit tests themselves using the pytest framework, a very lightweight and well-maintained unit-testing
      framework for Python.</p>

    <h3>Backend</h3>
    <h4>Design</h4>
    <p>Our backend needed to support accesses and persistent updates to users' high scores. Further, we needed to
      authenticate users so that a bad actor could not change another user's score. These two requirements are somewhat
      fundamentally coupled, as we need to save users' usernames and passwords in persistent storage. However, it would
      also be highly insecure to store users' passwords in plaintext in our database, as sensitive data would be exposed
      if our database were compromised. Additionally, we had to consider how the GUI would interact with the frontend,
      which presented the choice of whether or not to implement a serverless backend. Thus, implementing a secure
      backend was a non-trivial challenge; we now describe and justify the design decisions we made.</p>
    <h5>Traditional or Serverless?</h5>
    <p>Initially, we had wished to use a serverless backend; i.e. one where the GUI interacts with the database
      directly, as opposed to using a deployed API as a middleman. We elected to use Firebase, the serverless backend we
      were most familiar with. However, we almost immediately ran into issues when we learned that Firebase does not
      support desktop applications. This forced us to pivot to a more flexible server-based backend. In this scheme, we
      would write a REST API that would be deployed on a server; this service would accept and authenticate incoming
      HTTP requests and interact with the database on the requester's behalf. The GUI would then only interact with the
      database indirectly by making HTTP requests to our service, a much more flexible interface.</p>
    <h5>Language Choice</h5>
    <p>This approach came with other unexpected benefits as well. If we were to employ a serverless backend, all of the
      code for interacting with the database would have to be written in Python as well. One could imagine using an FFI
      to support multiple languages, but this likely would be tedious and error-prone. Instead, using a traditional
      backend allowed us to write our service in any language we wished, as this code would be completely independent
      from that of the GUI.</p>
    <p>With this freedom in hand, we decided to implement the backend in TypeScript, a statically typed superset of
      JavaScript. This allowed us to take advantage of the rich JavaScript web ecosystem while still enjoying the
      benefits of type-safety. Further, TypeScript has excellent support for asynchronous operations (implemented with
      the Promise API) that were extremely useful when performing high-latency network operations, like interacting with
      the database.</p>
    <h5>Authentication</h5>
    <p>Authentication is also an objectively difficult problem to solve with many reasonable solutions. As discussed, we
      needed to store users' passwords in some shape to ensure that users of the app can only login if they have the
      correct credentials. To avoid storing them in plain-text, we hashed the user's passwords before storing them in
      the database using the bcrypt algorithm implemented in the <code>bcrypt.js</code> library. Then, when we would
      authenticate a
      user's login credentials, we would hash the provided password and check that it matches the hashed password
      recorded for that user in the database. This does mean, however, that we were transmitting users' passwords
      directly from the GUI to the service. We prevented an attacker from intercepting users' plaintext passwords by
      using the HTTPS protocol to ensure that this network traffic was encrypted.</p>
    <p>Additionally, we wanted to avoid sending the users' passwords every single time they wanted to perform some
      privileged operation, such as updating their high score. The typical scheme to address this problem involves
      sending the user an access token once their login credentials have first been authenticated. Then, the user can
      include this private access token in future requests to perform privileged operations as opposed to repeatedly
      sending their login credentials. We decided to use JSON Web Tokens to tackle this problem. Given a secret key,
      JSON web tokens allow you to encrypt some information, such as a username, into an access token; this process is
      called “signing” the token. This token can then be decrypted to get this information back; this process is called
      “validating” the token. We applied this technology by signing a web token when a user first logs in and then
      sending it back to the user via an HTTP response. Then, when a user attempts to perform a privileged operation,
      like changing their high score, they must include this token in their request. The server then validates this
      token to ensure that the request is not impersonating another user. Overall, we were highly pleased with how this
      scheme allowed our authentication to be both secure and elegant.</p>
    <div style="text-align:center;">
      <img class="img-rounded" src="img/jwt.png" alt="Generic placeholder image" style="width:75%;">
      <h4>Figure 2: JWT Authentication Cycle. <a href="https://cdn.auth0.com/content/jwt/jwt-diagram.png">Source</a>.
      </h4>
    </div>
    <h5>Interacting with the Database</h5>
    <p>Although we were not able to use Firestore on a desktop application, we still elected to use it as our database
      due to our familiarity with it. A Firestore database comprises a number of different collections, each of which
      can contain documents that store data or more nested collections. Because our use case is fairly simple, we
      decided that we would only need one collection called <code>users</code> that contains documents recording each
      user's data:
      their high score and password. We use the user's ID as the unique key for their document containing this data, as
      we maintain that duplicate usernames are not allowed.</p>
    <p>To implement functions that would directly interact with the Firestore directly, we had to use the Firebase Admin
      SDK, which was explicitly created for server-side use. This allowed our code to access Firebase using a “service
      account,” a secret key formatted as a JSON. We wrote different functions corresponding to the stateful actions a
      user would perform while playing the game. These included the following:
    </p>
    <ul>
      <li>Creating an account. For this action, we implemented a function <code>register</code> that takes a username
        and password
        and creates a new document in the <code>users</code> collection identified by that username. We then record the
        user's
        hashed password and a default high score of 0 in the newly created document. If a document with that username
        already exists, then we throw an error.</li>
      <li>Logging in to receive an access token. For this action, we created a function <code>login</code> that takes a
        username
        and unencrypted password and returns an access token for that user, if their credentials are correct. We look up
        the user's document in the <code>users</code> Firestore collection to view that user's hashed password; we then
        verify the
        provided password using the method described in the Authentication section. If the user's account has not yet
        been created or the provided password is incorrect, then we throw an error.</li>
      <li>Retrieving a single user's high score. We developed a function <code>highScore</code> that takes a username
        and returns
        the high score of the associated account. To accomplish this, we just looked up the document in the users
        collection associated with the provided username; if it does not exist, then that user's account has not yet
        been created and we throw an error.</li>
      <li>Setting a user's high score. To implement this functionality, we wrote a function <code>setHighScore</code>
        that took a
        username and the new high score as arguments. We then looked up this user's document in the <code>users</code>
        collection
        and updated the property of that document that tracks the high score. Like in the previous function, if this
        document does not exist then we throw an error.</li>
      <li>Retrieving the top high scores. To implement a leaderboard, we needed to be able to retrieve the top high
        scores across all users. We developed a function <code>highScores</code> that takes an optional parameter
        <code>max</code> indicating
        the maximum number of high scores to be returned. This was an excellent use case for Firestore “queries,” which
        emulate functionality of SQL databases. Specifically, we created a query that would first sort the user
        collection in descending order by high score and then take the first <code>max</code> high scores. If
        <code>max</code> was not
        provided, then we just return all of the high scores ranked in descending order.
      </li>
    </ul>
    <p>These functions comprised our service's interface to the database, allowing the service itself to interact with
      the database only indirectly through these functions. This allowed us to encapsulate the database itself; later,
      we could swap our database completely to something like MongoDB and just change the implementation of these core
      functions. Provided the new implementations still respect their specification, the users of these functions would
      not have to modify their code at all.</p>
    <div style="text-align:center;">
      <img class="img-rounded" src="img/firestore.png" alt="Firestore" style="width:75%;">
      <h4>Figure 3: Firestore</h4>
    </div>
    <h5>API</h5>
    <p>Having decided that we would employ a traditional server-based backend, we now needed to settle upon a
      well-defined API (application programming interface) for our service. We created an endpoint for every user action
      described in the previous section, but no more; we wanted our API to be as simple as possible. We prescribe that
      the input information to each action must be provided in the request body, while the output of the action is
      returned through the response body. We wrote and generated the following documentation for our API using Swagger
      UI; it is also publicly available through navigating to the /docs endpoint. </p>
    <div class="center-block" style="text-align:center;">
      <iframe src="https://ece5725.herokuapp.com/docs/" width="640" height="360" frameborder="0"></iframe>
      <h4>Figure 4: Swagger documentation of our API</h4>
    </div>
    <h5>Service Implementation</h5>
    <p>Having made all of these design decisions, we were now ready to actually implement our backend in TypeScript. We
      decided to use the Express framework to generate routes for our service, which is probably the most common and
      well-maintained solution available. We first created an instance of an Express application and then attached
      different routes to it; an Express instance has a method for each type of HTTP request. These methods accept both
      the literal route itself and a callback that will be called when that request to the route is made. This callback
      accepts both the HTTP request and the HTTP response instance. Translating our OpenAPI specification into a
      functional express application was not difficult once we had fully planned out every endpoint we needed to create.
      As described in the previous section, every endpoint corresponds almost exactly to a single core function that
      interacts with the database</p>
    <p>When each of these endpoints are accessed, we will invoke the corresponding function developed in the previous
      section; for example, we would call the <code>login</code> function when the “/login” endpoint is accessed. In
      order to do
      this, the requester must include the necessary information in either the request body or query parameters when
      accessing an endpoint. Considering again the “/login” endpoint, the requester must include a username and password
      in the request body to pass as arguments to the <code>login</code> function. Then, we would send the result
      returned by this
      function (if any) in the response body with a 200 status code on success, a 400 error code if required information
      was not provided in the request body, and a 401 error code if we were unable to authenticate the user for a
      privileged operation. This completed our implementation of the service.</p>
    <h5>Service Deoplyment</h5>
    <p>We deployed our API using Heroku, which hosts our service publicly at https://ece5725.herokuapp.com/. Deploying
      with Heroku is fairly simple, although there was some setup involved. Firstly, as far as we know, Heroku cannot
      interpret TypeScript programs directly. This meant that we first had to compile our TypeScript code to JavaScript
      using the <code>tsc</code> compiler that would be directly interpreted by heroku. In order to do this, we
      specified that
      Heroku should invoke the TypeScript compiler after building our package with a postinstall script. We also had to
      inject secret keys, including the Firebase service account and JSON web token secret key, into Heroku's runtime
      environment. Heroku offers excellent Git integration that allows us to deploy by simply pushing to a remote
      repository hosted by them.</p>
    <h5>Interface to GUI</h5>
    <p>The GUI needed to interact with the service by making HTTP requests to its various endpoints using the ‘requests'
      library. We wanted to, however, encapsulate our service similar to how we encapsulated our database. As we did
      before, we developed a lightweight wrapper around the actual HTTP requests to our service. We also wanted to
      encapsulate the authentication scheme we were using; forcing the GUI to explicitly pass around access tokens would
      have broken encapsulation. Overall, we aimed to design the interface to the GUI so that the service could be
      drop-in replaced with another backend solution, such as a serverless backend.</p>
    <p>This motivated us to develop a ‘User' class which represents an abstract user of 2048. The constructor of this
      class takes a username and password, makes a POST request to the “/login” endpoint with these credentials in the
      request body, and saves the resulting access token from the response body to the object's state. If the response
      from the endpoint is not 200, then this means the login failed, and the constructor throws a custom
      <code>InvalidCredentialsError</code>.
    </p>
    <p>Then, we added a <code>high_score</code> method to the User class that fetches and returns the high score of the
      associated
      user. We implemented this by making a GET request to the “/high-score” endpoint where the ‘x-access-token' header
      is set to the access token saved in the User instance's state. This demonstrates how we were able to successfully
      encapsulate the access token within the User class.</p>
    <p>Similarly, we developed a method <code>set_high_score</code> that updates a user's high score in the database. To
      implement
      this, we made a POST request to the “/high-score” endpoint including the provided score in the request body and,
      again, the user's access token in the ‘x-access-token' header.</p>
    <p>We also had to develop some functions that were not associated with a User instance. For example, we developed a
      standalone function <code>create_account</code> that takes a username and password as arguments and attempts to
      create an
      account with the given credentials, returning <code>True</code> on success and <code>False</code> on failure. The
      implementation of this
      function was fairly simple; we made a POST request to the “/register” endpoint with the provided username and
      password in the request body. If the response status code is 200, then we return <code>True</code>; otherwise, we
      return
      <code>False</code>.
    </p>
    <p>Finally, we developed a function <code>all_high_scores</code> that takes an optional argument <code>limit</code>
      and returns at most
      <code>limit</code> top high scores, ranked in descending order. Again the implementation of this function was
      fairly simple;
      it makes a GET request to the “/high-score/rankings” endpoint. If the optional <code>limit</code> argument is
      provided, we
      also include this as a query parameter to the GET request. We then return the list of high scores from the
      response body. This completed the lightweight implementation of the interface between our service and the GUI.
    </p>
    <h4>Testing</h4>
    <p>Testing our service was imperative in ensuring that our endpoints functioned correctly. We made extensive use of
      Postman to test our API. Postman allows you to create and save HTTP requests to be run systematically at different
      times. This was especially useful when we were first developing our service and we were running it locally. We
      used Postman to make requests to port 8080 on our local machine before actually deploying it to ensure that we did
      not deploy broken code. We used our OpenAPI specification to guide the cases we tested; our documentation
      enumerated all valid request schemas for an endpoint and also different classes of invalid requests. This
      motivated us to test the following properties for every endpoint:</p>
    <ul>
      <li>Every valid request sends back the correct response with all required information in the body.</li>
      <li>Every invalid request sends back the status code specified by our OpenAPI documentation.</li>
    </ul>
    <p>For example, we tested that a POST request to the “/login” endpoint with an existing username and correct
      password resulted in a response containing an access token. We then used this access token when testing other
      endpoints that required them to authenticate the user, such as a POST request to the “/high-score” endpoint. We
      also tested that omitting required information from the body of a POST request to the “/login” endpoint resulted
      in a 400 response, and providing invalid credentials resulted in a 401 response.</p>

    <div style="text-align:center;">
      <img class="img-rounded" src="img/postman.png" alt="Postman" style="width:75%;">
      <h4>Testing our API with Postman</h4>
    </div>

    <h3>GUI</h3>
    <h4>Design</h4>
    <p>Our GUI was designed using the pygame library, consisting of three views: the login page, the game screen, and
      the leaderboard.</p>

    <h5>Game Screen</h5>
    <p>We began by first designing the GUI for the game screen by displaying a square grid with a default size of four
      by four, which could be changed when specified by the user. This was implemented using a ‘draw’ method, created
      inside of the ‘Board’ class, which when called, displays the current state of the board. This ‘draw’ method loops
      through each spot inside of the board matrix to access its corresponding value and, subsequently, associate the
      tile’s value with its corresponding tile color to ultimately display the grid of colored, number tiles on the
      pygame screen. In order to interactively update the player’s view, we redrew the board in every iteration of the
      game’s main loop, ensuring that the user would be able to see the tiles shift and therefore, the board change in
      response to their input of the direction to shift the tiles.
      To the right of the board, we displayed these five items: the player’s current score, a ‘New Game’ button, a
      ‘Quit’ button, a ‘Scores’ button’, and a ‘Logout’ button. The player’s current score is a value calculated in the
      ‘Board’ class each time the player shifts the tiles in a direction. This value was then accessed to display to the
      player how their progress in the game is going. The ‘New Game’ button, when pressed, refreshes the board by
      assigning the board object to an empty board, randomly adds a new tile of the value two or four, and in the next
      iteration of the main game loop, this new game board is displayed using the ‘draw’ method described above. The
      ‘Quit’ button, when pressed, terminates the game. Clicking this button is the only way that the user is able to
      exit the game. The ‘Scores’ button, when pressed, navigates to a new view of the game, called the ‘Leaderboard,’
      where the top seven players are displayed with their respective scores to allow players of the game to see how
      their skill might compare with other players in the game. Finally, the ‘Logout’ button, when clicked, interacts
      with the API to log the user out of their session and navigates to the ‘Login Screen’ to allow the user to either
      login again or to allow another user to create an account or login.
    </p>

    <h5>Login Screen</h5>
    <p>After completing the implementation of the ‘Game Screen,’ we next designed the GUI for the ‘Login Screen,’ the
      view which allows the user to input a username and password in order to either create an account, or to log into
      their existing account, to then begin playing the game. We implemented this by creating a new class called ‘Login’
      in order to modularize our code, and allow the main function to call only the necessary functions when displaying
      the login screen. Inside of the ‘Login’ class, we created a ‘draw’ method, which when called, uses pygame to
      display the current state of all of the login screen components to the user. Implementing the username and
      password textboxes and allowing for user input while also displaying this input interactively was the trickiest
      part. In order to do so, we initially created and displayed two rectangular boxes, which change color based on
      whether they have been the most recently clicked item on the screen, onto the pygame window. After doing this, we
      used the current state of the user’s input of their username and their password, which is handled in the ‘Login’
      class’s ‘handle_events’ method, in order to create two new respective pygame Rects. Displayed beneath the two text
      boxes are two buttons: the button ‘Login’ and the button ‘Create Account.’ The ‘Login’ button acts as a navigation
      button, which navigates to the ‘Game Screen’ if the username and password entered are verified using the API as
      existing and correct. If the API indicates that the username and password entered are not correct, then the
      ‘Login’ button does not navigate to the ‘Game Screen,’ and instead, “Incorrect username or password” is displayed
      below the ‘Login’ and ‘Create Account’ buttons to communicate with the user that what they have entered does not
      correspond with an account in the database. The ‘Create Account’ button serves as a way for the user to interact
      with the database to create a new account. If a new account is successfully made, then the message “Success!” is
      displayed. If an account that already exists is attempted to be created, nothing is displayed, indicating that
      there has been no change in the database. Once an account has been successfully created, the user can click the
      ‘Login’ button to then successfully login and navigate to the ‘Game Screen.’ We used this ‘draw’ method of the
      ‘Login’ class inside of the main code and while the user was in the ‘Login Screen’, we called it on each iteration
      of the main game’s loop, allowing for the text being displayed in the username and password box to be interactive
      with the user’s keyboard input.</p>

    <div style="text-align:center;">
      <img class="img-rounded" src="img/game.png" alt="Game screen" style="width:40%;">
      <h4>Figure 5: Game Screen</h4>
    </div>

    <p>Taking in the text input from the user to then be displayed using the ‘draw’ method was handled inside of the
      ‘handle_events’ method of the ‘Login’ class. The ‘handle_events’ method, when called, uses pygame to loop through
      all events detected from the user interacting with the GUI to do different actions based on the event.
      Specifically for the text boxes, we looped through all keyboard events. If a keyboard event was detected, the
      ‘handle_events’ method of the ‘Login’ class checks if it came from the keyboard’s backspace button. If so, then
      the method takes out the last character in either the username text or the password text, depending on which one
      was selected. If, instead, a keyboard event was detected but not from the keyboard’s backspace buttons, then the
      ‘handle_events’ method would concatenate the detected unicode character to the end of the username text string or
      the password text string, depending on which one was selected. If, instead, neither the username nor the password
      text boxes were selected in the GUI, then a keyboard event would result in no change to either of their text
      strings. The ‘handle_events’ method of the ‘Login’ class also detects mouse click events to check for if the
      ‘Login’ button or the ‘Create Account’ button were clicked, and presents new messages or views to the user, as
      described above.</p>

    <div class="row" style="text-align:center;">
      <div class="col-md-6">
        <img src="img/login.png" alt="Login Screen" style="width:75%" />
        <h4>Figure 6: Login Screen</h4>
      </div>
      <div class="col-md-6">
        <img src="img/login-invalid.png" alt="Incorrect Credentials" style="width:75%">
        <h4>Figure 7: Attempting to Login With Invalid Credentials</h4>
      </div>
    </div>

    <h5>Leaderboard</h5>
    <p>Finally, we implemented the ‘Leaderboard,’ the view that allows any user to see how their scores compare with the
      top seven highest scores. The ‘Leaderboard’ screen can be reached from the ‘Game Screen’ view by clicking the
      ‘Scores’ button. After clicking the ‘Scores’ button, the user navigates to this new screen where they are able to
      see the highest seven scores and the usernames of the corresponding player who reached these scores, as well as a
      ‘Back’ button, which when clicked allows them to navigate back to the ‘Game Screen’ and continue their progress in
      their current game. We implemented this by creating a ‘Leaderboard’ class which consists of a ‘draw’ method and a
      ‘handle_events’ method. The ‘handle_events’ method only checks for the event that the ‘Back’ button has been
      clicked. In the case of this event, it navigates the view back to the ‘Game Screen.’ The ‘draw’ method uses the
      ‘all_high_scores’ method from API to get the seven highest scores. After getting these scores, the ‘draw’ method
      loops through the scores in order to display the usernames and their corresponding highest scores using pygame.
    </p>

    <div style="text-align:center;">
      <img class="img-rounded" src="img/leaderboard.png" alt="Game screen" style="width:40%;">
      <h4>Figure 8: Leaderboard</h4>
    </div>

    <h4>Testing</h4>
    <p>Testing our GUI was very important to ensure that the users are able to properly interact with the game and
      ultimately play 2048. We tested the GUI using our local computers, using the size of the piTFT screen for the
      pygame window, in order to simulate the user playing the game using the piTFT and to allow for quick feedback and
      turn around time. Each change that was made on the GUI was then checked by running the game in the pygame window
      to ensure that the change worked and that we could safely move to implementing the next feature of the GUI. This
      process allowed us to catch any errors quickly and prevent them from creating issues with the next features
      implemented. After ensuring that the GUI properly worked on our local computers, we then began testing the GUI and
      the user interaction on the piTFT to troubleshoot any outstanding issues.</p>

    <hr id='results'>

    <div class="section">
      <h2>Results</h2>
      <p>Overall, we were highly pleased with the outcome of our project; we were able to successfully develop a 2048
        game playable on the Raspberry Pi and found that every subsystem worked correctly. You could create an account,
        login, play 2048 using the tactile switches, and save your high score for viewing on a different device. Thus,
        we were able to accomplish all of our baseline goals and most of our stretch goals.</p>
      <p>However, we did encounter several issues along the way, some of which were difficult to debug. One particular
        defeating instance was when we first deployed the service to Heroku and it immediately crashed; this was
        especially confusing to us because we had extensively tested the service locally before deploying it. Upon
        viewing the logs, we found a cryptic error that stated the Firebase service account was invalid even though we
        had injected it into the runtime environment. Upon some debugging, we found that Heroku had injected it into the
        runtime environment as a raw string, which in hindsight was to be expected. This was, however, solved easily by
        parsing the service account injected into the runtime environment.</p>
      <p>While conducting local testing of our service, we also found that the response of the “/high-score/rankings”
        endpoint was incorrect; instead of returning an array of scores, it was returning an empty object. Upon
        debugging, we found that we were actually sending a Promise wrapping the scores in the response. This issue was
        again easily fixed by waiting for the promise to resolve with the scores before sending them in the response.
      </p>
      <p>Beyond these relatively minor issues, however, most aspects of our project were very smooth. We were able to
        quickly and effectively debug all issues we encountered, a testament to our thorough testing and documentation.
      </p>
    </div>

    <hr id='conclusion'>

    <div class="section">
      <h2>Conclusion</h2>
      <p>Overall, building 2048 to be played on the Raspberry Pi proved to be an insightful experience in building
        embedded systems integrated with the cloud. We were not able to gain experience with cloud integration in other
        labs in the class, so this project demonstrated that it was both relatively painless to achieve and extremely
        fruitful. Cloud integration opened up our project to limitless possibilities while also presenting many
        interesting design challenges. Tracking high scores was only one application of cloud integration; it would
        likely not be difficult to add other network-forward features. Further, we were pleasantly surprised with the
        effectiveness of our traditional server-based backend, as it allowed our systems to be even more decoupled than
        they would have with a serverless backend. Generally, we found that encapsulating different parts of our
        technology stack allowed us to isolate our different subsystems and write clearer code that interfaced between
        them. This allowed us in turn to be maximally productive; both of us could work on completely decoupled code.
        Had we not been able to do this, we likely would not have been able to accomplish all of our stretch goals. </p>
    </div>

    <hr id='future'>

    <div class="section">
      <h2>Future Work</h2>
      <p>Now that we have added cloud integration to our 2048 game, there are many possible avenues of future features,
        both hardware and software-central. One of our stretch goals that we did not end up implementing was realtime
        competition between players on different devices. In this scheme, different players from remote locations could
        view each other's moves in real time and the first player to reach 2048 would win. This would likely be
        difficult to implement smoothly due to network latencies, but we would likely attempt to do so using the
        WebSockets protocol. In contrast to HTTP, communication via WebSockets allows you to send interrupt-style
        updates between the client and the server. The alternative would be to use HTTP polling to continuously check
        for updates, which is inherently inefficient. Both players could then use WebSockets to send and receive real
        time updates to the server.</p>
    </div>

    <hr>

    <div class="row" style="text-align:center;">
      <h2>Work Distribution</h2>
      <div style="text-align:center;">
        <img class="img-rounded" src="img/group.jpg" alt="Generic placeholder image" style="width:80%;">
        <h4>Project group picture</h4>
      </div>
      <div class="col-md-6" style="font-size:16px">
        <img class="img-rounded" src="img/a.png" alt="Generic placeholder image" width="240" height="240">
        <h3>Zak</h3>
        <p class="lead">zak33@cornell.edu</p>
        <p>Developed the game logic, backend, and setup website.
      </div>
      <div class="col-md-6" style="font-size:16px">
        <img class="img-rounded" src="img/b.png" alt="Generic placeholder image" width="240" height="240">
        <h3>Nadia</h3>
        <p class="lead">nnb28@cornell.edu</p>
        <p>Developed the GUI and integration with GPIO; described these in lab report.
      </div>
    </div>

    <hr>
    <div style="font-size:18px">
      <h2>Parts List</h2>
      <ul>
        <li>Raspberry Pi $0.00 (Provided)</li>
        <li>Raspberry Pi TFT $0.00 (Provided)</li>
        <li>Heroku Deployment Fees $7</li>
      </ul>
      <h3>Total: $7</h3>
    </div>
    <hr>
    <div style="font-size:18px">
      <h2>References</h2>
      <ul>
        <li><a href="https://firebase.google.com/docs/reference/admin">Firebase Admin SDK Reference</a><br></li>
        <li><a href="https://auth0.com/docs/secure/tokens/json-web-tokens">Explanation of JSON Web Tokens</a><br></li>
        <li><a
            href="https://medium.com/@prashantramnyc/authenticate-rest-apis-in-node-js-using-jwt-json-web-tokens-f0e97669aad3">JSON
            Web Token Tutorial</a><br></li>
        <li><a href="https://dev.to/crrojas88/deploying-a-git-subdirectory-to-heroku-23ld">Deploying a Git Subdirectory
            to Heroku</a><br>
        </li>
        <li><a href="https://sourceforge.net/p/raspberry-gpio-python/wiki/Home/">R-Pi GPIO Documentation</a><br></li>
        <li><a href="https://support.smartbear.com/swaggerhub/docs/tutorials/openapi-3-tutorial.html">OpenAPI
            Reference</a></li>
      </ul>


    </div>

    <hr>

    <div class="row">
      <h2>Code Appendix</h2>
      <p>Our repo is publicly available <a href="https://github.com/zachary0kent/ece5725-final">here</a>. Additionally,
        we have attached our code below.</p>
      <h3>api.py</h3>
      <!-- HTML generated using hilite.me -->
      <div
        style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <table>
          <tr>
            <td>
              <pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre>
            </td>
            <td>
              <pre style="margin: 0; line-height: 125%"><span style="color: #888888">#</span>
<span style="color: #888888"># zak33, nnb28, 5/17/23: api.py</span>
<span style="color: #888888"># </span>
<span style="color: #888888"># Interacts with the deployed service to create users, login, and query their</span>
<span style="color: #888888"># high scores</span>
<span style="color: #888888">#</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">requests</span>

<span style="color: #888888"># The URL of the service</span>
URL <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;https://ece5725.herokuapp.com&#39;</span>

<span style="color: #888888"># Attempts to create a new user with the specified user name and password</span>
<span style="color: #888888"># Returns whether the creation of the account was successful</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">create_account</span>(username, password):
    body <span style="color: #333333">=</span> {<span style="background-color: #fff0f0">&#39;username&#39;</span>: username, <span style="background-color: #fff0f0">&#39;password&#39;</span>: password}
    resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>post(f<span style="background-color: #fff0f0">&#39;{URL}/register&#39;</span>, json<span style="color: #333333">=</span>body)
    <span style="color: #008800; font-weight: bold">return</span> resp<span style="color: #333333">.</span>status_code <span style="color: #333333">==</span> requests<span style="color: #333333">.</span>codes<span style="color: #333333">.</span>ok


<span style="color: #888888"># An error raised when invalid credentials are entered</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">InvalidCredentialsError</span>(<span style="color: #FF0000; font-weight: bold">Exception</span>):
    <span style="color: #008800; font-weight: bold">pass</span>

<span style="color: #888888"># Represents a user of 2048</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">User</span>:

    <span style="color: #888888"># Attempt to login with the provided credentials.</span>
    <span style="color: #888888"># Raises `InvalidCredentialsError` if they are invalid</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, username, password):
        body <span style="color: #333333">=</span> {<span style="background-color: #fff0f0">&#39;username&#39;</span>: username, <span style="background-color: #fff0f0">&#39;password&#39;</span>: password}
        resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>post(f<span style="background-color: #fff0f0">&#39;{URL}/login&#39;</span>, json<span style="color: #333333">=</span>body)
        <span style="color: #008800; font-weight: bold">if</span> resp<span style="color: #333333">.</span>status_code <span style="color: #333333">!=</span> requests<span style="color: #333333">.</span>codes<span style="color: #333333">.</span>ok:
            <span style="color: #008800; font-weight: bold">raise</span> InvalidCredentialsError
        <span style="color: #007020">self</span><span style="color: #333333">.</span>token <span style="color: #333333">=</span> resp<span style="color: #333333">.</span>json()[<span style="background-color: #fff0f0">&#39;token&#39;</span>]

    <span style="color: #888888"># Get the high score of this user</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">high_score</span>(<span style="color: #007020">self</span>):
        headers <span style="color: #333333">=</span> {<span style="background-color: #fff0f0">&#39;x-access-token&#39;</span>: <span style="color: #007020">self</span><span style="color: #333333">.</span>token}
        resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>get(f<span style="background-color: #fff0f0">&#39;{URL}/high-score&#39;</span>, headers<span style="color: #333333">=</span>headers)
        <span style="color: #008800; font-weight: bold">if</span> resp<span style="color: #333333">.</span>status_code <span style="color: #333333">!=</span> requests<span style="color: #333333">.</span>codes<span style="color: #333333">.</span>ok:
            <span style="color: #008800; font-weight: bold">raise</span> InvalidCredentialsError
        <span style="color: #008800; font-weight: bold">return</span> resp<span style="color: #333333">.</span>json()[<span style="background-color: #fff0f0">&#39;score&#39;</span>]

    <span style="color: #888888"># Sets the high score of this user. Does nothing if the provided score</span>
    <span style="color: #888888"># is less than or equal to their current high score.</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">set_high_score</span>(<span style="color: #007020">self</span>, score):
        headers <span style="color: #333333">=</span> headers <span style="color: #333333">=</span> {<span style="background-color: #fff0f0">&#39;x-access-token&#39;</span>: <span style="color: #007020">self</span><span style="color: #333333">.</span>token}
        body <span style="color: #333333">=</span> {<span style="background-color: #fff0f0">&#39;score&#39;</span>: score}
        resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>post(f<span style="background-color: #fff0f0">&#39;{URL}/high-score&#39;</span>, json<span style="color: #333333">=</span>body, headers<span style="color: #333333">=</span>headers)
        <span style="color: #008800; font-weight: bold">if</span> resp<span style="color: #333333">.</span>status_code <span style="color: #333333">!=</span> requests<span style="color: #333333">.</span>codes<span style="color: #333333">.</span>ok:
            <span style="color: #008800; font-weight: bold">raise</span> InvalidCredentialsError

<span style="color: #888888"># All high scores, associated with the corresponding user, listed in descending order</span>
<span style="color: #888888"># Returns at most limit results, if provided</span>
<span style="color: #888888"># Example result: [{ &#39;username&#39;: &#39;zak&#39;, &#39;score&#39;: 3}, { &#39;username&#39;: &#39;nadia&#39;, &#39;score&#39;: 2}]</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">all_high_scores</span>(limit<span style="color: #333333">=</span><span style="color: #007020">None</span>):
   route_url <span style="color: #333333">=</span> f<span style="background-color: #fff0f0">&#39;{URL}/high-score/rankings&#39;</span>
   <span style="color: #008800; font-weight: bold">if</span> limit <span style="color: #000000; font-weight: bold">is</span> <span style="color: #007020">None</span>:
      resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>get(route_url)
   <span style="color: #008800; font-weight: bold">else</span>:
      params <span style="color: #333333">=</span> { <span style="background-color: #fff0f0">&#39;limit&#39;</span>: <span style="color: #007020">str</span>(limit) }
      resp <span style="color: #333333">=</span> requests<span style="color: #333333">.</span>get(route_url, params<span style="color: #333333">=</span>params)
   <span style="color: #008800; font-weight: bold">return</span> resp<span style="color: #333333">.</span>json()[<span style="background-color: #fff0f0">&#39;scores&#39;</span>] <span style="color: #008800; font-weight: bold">if</span> resp<span style="color: #333333">.</span>status_code <span style="color: #333333">==</span> requests<span style="color: #333333">.</span>codes<span style="color: #333333">.</span>ok <span style="color: #008800; font-weight: bold">else</span> []
</pre>
            </td>
          </tr>
        </table>
      </div>
      <h3>backend/user.ts</h3>
      <!-- HTML generated using hilite.me -->
      <div
        style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <table>
          <tr>
            <td>
              <pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre>
            </td>
            <td>
              <pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> { readFileSync } from <span style="background-color: #fff0f0">&#39;fs&#39;</span>
<span style="color: #008800; font-weight: bold">import</span> { initializeApp, cert } from <span style="background-color: #fff0f0">&#39;firebase-admin/app&#39;</span>
<span style="color: #008800; font-weight: bold">import</span> { getFirestore } from <span style="background-color: #fff0f0">&#39;firebase-admin/firestore&#39;</span>
<span style="color: #008800; font-weight: bold">import</span> { hash, compare } from <span style="background-color: #fff0f0">&#39;bcryptjs&#39;</span>;
<span style="color: #008800; font-weight: bold">import</span> { sign } from <span style="background-color: #fff0f0">&#39;jsonwebtoken&#39;</span>;

<span style="color: #888888">/* </span>
<span style="color: #888888"> * zak33, nnb28, 5/17/23: user.ts</span>
<span style="color: #888888"> * </span>
<span style="color: #888888"> * Interacts with the database to create users and query their high scores</span>
<span style="color: #888888"> */</span>

<span style="color: #888888">/** The secret key used to access our Firestore */</span>
<span style="color: #008800; font-weight: bold">const</span> serviceAccount <span style="color: #333333">=</span> JSON.parse(process.env.SERVICE_ACCOUNT <span style="color: #333333">??</span> readFileSync(<span style="background-color: #fff0f0">&#39;./serviceAccount.json&#39;</span>).toString());

<span style="color: #008800; font-weight: bold">const</span> credential <span style="color: #333333">=</span> cert(serviceAccount);

<span style="color: #888888">/** The Firebase app itself */</span>
<span style="color: #008800; font-weight: bold">const</span> app <span style="color: #333333">=</span> initializeApp({ credential })

<span style="color: #888888">/** The database associated with our Firebase app */</span>
<span style="color: #008800; font-weight: bold">const</span> firestore <span style="color: #333333">=</span> getFirestore(app);

<span style="color: #888888">/** Represents a user in Firestore */</span>
type FirestoreUser <span style="color: #333333">=</span> {
  <span style="color: #888888">/** The hashed password of this user */</span>
  password: <span style="color: #333399; font-weight: bold">string</span>
  <span style="color: #888888">/** The high score of this user */</span>
  score: <span style="color: #333399; font-weight: bold">number</span>
}

<span style="color: #888888">/** The collection of all 2048 userss */</span>
<span style="color: #008800; font-weight: bold">const</span> users <span style="color: #333333">=</span> firestore.collection(<span style="background-color: #fff0f0">&#39;users&#39;</span>)

<span style="color: #888888">/** A user, as viewed by the API */</span>
type User <span style="color: #333333">=</span> {
  <span style="color: #888888">/** The username of this user */</span>
  username: <span style="color: #333399; font-weight: bold">string</span>
  <span style="color: #888888">/** This user&#39;s plaintext password */</span>
  password: <span style="color: #333399; font-weight: bold">string</span>
};

<span style="color: #888888">/**</span>
<span style="color: #888888"> * Create a new user in the database</span>
<span style="color: #888888"> * </span>
<span style="color: #888888"> * @param user the user to create</span>
<span style="color: #888888"> */</span>
<span style="color: #008800; font-weight: bold">export</span> <span style="color: #008800; font-weight: bold">const</span> createUser <span style="color: #333333">=</span> async ({ username, password }<span style="color: #333333">:</span> User) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> userDocRef <span style="color: #333333">=</span> users.doc(username)
  <span style="color: #008800; font-weight: bold">const</span> userDoc <span style="color: #333333">=</span> await userDocRef.get();
  <span style="color: #008800; font-weight: bold">if</span> (userDoc.exists) {
    <span style="color: #888888">// Do not overwrite existing user</span>
    <span style="color: #008800; font-weight: bold">throw</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #007020">Error</span>(<span style="background-color: #fff0f0">&#39;User already exists&#39;</span>);
  }
  <span style="color: #888888">// Create new user</span>
  await userDocRef.set({
    password: <span style="color: #333399; font-weight: bold">await</span> hash(password, <span style="color: #0000DD; font-weight: bold">8</span>),
    score: <span style="color: #333399; font-weight: bold">0</span>,
  })
};

<span style="color: #888888">/**</span>
<span style="color: #888888"> * Get the high score of a user</span>
<span style="color: #888888"> * </span>
<span style="color: #888888"> * @param username the user&#39;s name</span>
<span style="color: #888888"> * @returns The high score of user with username `username`</span>
<span style="color: #888888"> */</span>
<span style="color: #008800; font-weight: bold">export</span> <span style="color: #008800; font-weight: bold">const</span> highScore <span style="color: #333333">=</span> async (username: <span style="color: #333399; font-weight: bold">string</span>)<span style="color: #333333">:</span> Promise<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">number</span><span style="color: #333333">&gt;</span> <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> docRef <span style="color: #333333">=</span> users.doc(username);
  <span style="color: #008800; font-weight: bold">const</span> userDoc <span style="color: #333333">=</span> await docRef.get();
  <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>userDoc.exists) {
    <span style="color: #888888">// User does not exist in database</span>
    <span style="color: #008800; font-weight: bold">throw</span> <span style="color: #008800; font-weight: bold">new</span> UserNotFound();
  }
  <span style="color: #008800; font-weight: bold">return</span> userDoc.data().score;
}

<span style="color: #888888">/**</span>
<span style="color: #888888"> * Get an array of ranked high scores</span>
<span style="color: #888888"> * </span>
<span style="color: #888888"> * @param max The maximum number of scores to return</span>
<span style="color: #888888"> * @returns At most `max` high scores</span>
<span style="color: #888888"> */</span>
<span style="color: #008800; font-weight: bold">export</span> <span style="color: #008800; font-weight: bold">const</span> highScores <span style="color: #333333">=</span> async (max?: <span style="color: #333399; font-weight: bold">number</span>)<span style="color: #333333">:</span> Promise<span style="color: #333333">&lt;</span><span style="color: #007020">Array</span><span style="color: #333333">&lt;</span>{ username: <span style="color: #333399; font-weight: bold">string</span>; score: <span style="color: #333399; font-weight: bold">number</span> }<span style="color: #333333">&gt;&gt;</span> <span style="color: #333333">=&gt;</span> {
  <span style="color: #888888">// User all users in descending order of high score</span>
  <span style="color: #008800; font-weight: bold">let</span> q <span style="color: #333333">=</span> users.orderBy(<span style="background-color: #fff0f0">&#39;score&#39;</span>, <span style="background-color: #fff0f0">&#39;desc&#39;</span>);
  <span style="color: #008800; font-weight: bold">if</span> (max <span style="color: #333333">!=</span> <span style="color: #008800; font-weight: bold">null</span>) {
    <span style="color: #888888">// If maximum number given, limit query</span>
    q <span style="color: #333333">=</span> q.limit(max);
  }
  <span style="color: #888888">// Execute query</span>
  <span style="color: #008800; font-weight: bold">const</span> { docs } <span style="color: #333333">=</span> await q.get();
  <span style="color: #008800; font-weight: bold">return</span> docs.map(doc <span style="color: #333333">=&gt;</span> {
    <span style="color: #008800; font-weight: bold">const</span> { score } <span style="color: #333333">=</span> doc.data() <span style="color: #008800; font-weight: bold">as</span> FirestoreUser;
    <span style="color: #008800; font-weight: bold">return</span> { username: <span style="color: #333399; font-weight: bold">doc.id</span>, score };
  });
}

<span style="color: #888888">/**</span>
<span style="color: #888888"> * Set a user&#39;s high score in the database</span>
<span style="color: #888888"> * </span>
<span style="color: #888888"> * @param username the username of the user</span>
<span style="color: #888888"> * @param score the new high score</span>
<span style="color: #888888"> * @returns a Promise that resolves when the high score is updated in Firestore</span>
<span style="color: #888888"> */</span>
<span style="color: #008800; font-weight: bold">export</span> <span style="color: #008800; font-weight: bold">const</span> setHighScore <span style="color: #333333">=</span> async (username: <span style="color: #333399; font-weight: bold">string</span>, score: <span style="color: #333399; font-weight: bold">number</span>) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> userDocRef <span style="color: #333333">=</span> users.doc(username);
  <span style="color: #008800; font-weight: bold">const</span> userDoc <span style="color: #333333">=</span> await userDocRef.get();
  <span style="color: #888888">// User does not exist in database</span>
  <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>userDoc.exists) <span style="color: #008800; font-weight: bold">throw</span> <span style="color: #008800; font-weight: bold">new</span> UserNotFound();
  <span style="color: #888888">// Do nothing if new score is less than current high score</span>
  <span style="color: #008800; font-weight: bold">if</span> (userDoc.data().score <span style="color: #333333">&gt;=</span> score) <span style="color: #008800; font-weight: bold">return</span>;
  await userDocRef.update({ score });
}

<span style="color: #888888">/** Represents an error indicating that the requested user does not exist */</span>
<span style="color: #008800; font-weight: bold">export</span> <span style="color: #008800; font-weight: bold">class</span> UserNotFound <span style="color: #008800; font-weight: bold">extends</span> <span style="color: #007020">Error</span> {
  <span style="color: #008800; font-weight: bold">constructor</span>(msg?: <span style="color: #333399; font-weight: bold">string</span>) {
    <span style="color: #008800; font-weight: bold">super</span>(msg);
    <span style="color: #007020">Object</span>.setPrototypeOf(<span style="color: #008800; font-weight: bold">this</span>, UserNotFound.prototype);
  }
}

<span style="color: #888888">/** Represents an error indicating that an incorrect password was entered */</span>
<span style="color: #008800; font-weight: bold">export</span> <span style="color: #008800; font-weight: bold">class</span> IncorrectPassword <span style="color: #008800; font-weight: bold">extends</span> <span style="color: #007020">Error</span> {
  <span style="color: #008800; font-weight: bold">constructor</span>(msg?: <span style="color: #333399; font-weight: bold">string</span>) {
    <span style="color: #008800; font-weight: bold">super</span>(msg);
    <span style="color: #007020">Object</span>.setPrototypeOf(<span style="color: #008800; font-weight: bold">this</span>, IncorrectPassword.prototype);
  }
}

<span style="color: #888888">/**</span>
<span style="color: #888888"> * Login to receive an access token</span>
<span style="color: #888888"> * </span>
<span style="color: #888888"> * @param user the provided credentials</span>
<span style="color: #888888"> * @returns An access token uniquely identiftying the user</span>
<span style="color: #888888"> */</span>
<span style="color: #008800; font-weight: bold">export</span> <span style="color: #008800; font-weight: bold">const</span> login <span style="color: #333333">=</span> async ({ username, password }<span style="color: #333333">:</span> User)<span style="color: #333333">:</span> Promise<span style="color: #333333">&lt;</span><span style="color: #333399; font-weight: bold">string</span><span style="color: #333333">&gt;</span> <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> userDocRef <span style="color: #333333">=</span> users.doc(username);
  <span style="color: #008800; font-weight: bold">const</span> userDoc <span style="color: #333333">=</span> await userDocRef.get();
  <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>userDoc.exists) {
    <span style="color: #008800; font-weight: bold">throw</span> <span style="color: #008800; font-weight: bold">new</span> UserNotFound();
  }
  <span style="color: #008800; font-weight: bold">const</span> user <span style="color: #333333">=</span> userDoc.data() <span style="color: #008800; font-weight: bold">as</span> FirestoreUser;
  <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #333333">!</span>await compare(password, user.password)) {
    <span style="color: #008800; font-weight: bold">throw</span> <span style="color: #008800; font-weight: bold">new</span> IncorrectPassword();
  }
  <span style="color: #008800; font-weight: bold">return</span> sign(username, process.env.SECRET);
}
</pre>
            </td>
          </tr>
        </table>
      </div>
      <h3>backend/index.ts</h3>
      <!-- HTML generated using hilite.me -->
      <div
        style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <table>
          <tr>
            <td>
              <pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150</pre>
            </td>
            <td>
              <pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> express from <span style="background-color: #fff0f0">&#39;express&#39;</span>
<span style="color: #008800; font-weight: bold">import</span> { verify } from <span style="background-color: #fff0f0">&#39;jsonwebtoken&#39;</span>;
<span style="color: #008800; font-weight: bold">import</span> { IncorrectPassword, UserNotFound, createUser, highScore, highScores, login, setHighScore } from <span style="background-color: #fff0f0">&#39;./user&#39;</span>;
<span style="color: #008800; font-weight: bold">import</span> { serve, setup } from <span style="background-color: #fff0f0">&#39;swagger-ui-express&#39;</span>
<span style="color: #008800; font-weight: bold">import</span> docs from <span style="background-color: #fff0f0">&#39;./docs.json&#39;</span>

<span style="color: #888888">/*</span>
<span style="color: #888888"> * zak33, nnb28, 5/17/23: index.ts</span>
<span style="color: #888888"> *</span>
<span style="color: #888888"> * Runs our API to accept and respond to incoming requests</span>
<span style="color: #888888"> */</span>

<span style="color: #888888">/** The express application */</span>
<span style="color: #008800; font-weight: bold">const</span> app <span style="color: #333333">=</span> express();

<span style="color: #888888">// Parse request bodies as JSON</span>
app.use(express.json())

<span style="color: #888888">// Setup the documentation endpoint</span>
app.use(<span style="background-color: #fff0f0">&#39;/docs&#39;</span>, serve, setup(docs))


<span style="color: #888888">/**</span>
<span style="color: #888888"> * Middleware for authenticating an access token and saving it in the</span>
<span style="color: #888888"> * locals of a request.</span>
<span style="color: #888888"> * </span>
<span style="color: #888888"> * @param req The HTTP request</span>
<span style="color: #888888"> * @param res The HTTP response</span>
<span style="color: #888888"> * @param next The next middleware in the application cycle</span>
<span style="color: #888888"> * @returns the reponse</span>
<span style="color: #888888"> */</span>
<span style="color: #008800; font-weight: bold">const</span> validateToken <span style="color: #333333">=</span> async (req, res, next) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> token <span style="color: #333333">=</span> req.headers[<span style="background-color: #fff0f0">&#39;x-access-token&#39;</span>];
  <span style="color: #008800; font-weight: bold">if</span> (token <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span>) {
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">401</span>).send(<span style="background-color: #fff0f0">&quot;Access token required&quot;</span>);
  }
  <span style="color: #008800; font-weight: bold">try</span> {
    <span style="color: #888888">// Get username token was signed with</span>
    <span style="color: #008800; font-weight: bold">const</span> username <span style="color: #333333">=</span> verify(token, process.env.SECRET);
    <span style="color: #888888">// Save username in locals of request</span>
    res.locals.username <span style="color: #333333">=</span> username;
  } <span style="color: #008800; font-weight: bold">catch</span> {
    <span style="color: #888888">// Token malformed</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">403</span>).send(<span style="background-color: #fff0f0">&quot;Invalid access token&quot;</span>);
  }
  <span style="color: #008800; font-weight: bold">return</span> next();
}

<span style="color: #888888">// Endpoint for creating an account</span>
app.post(<span style="background-color: #fff0f0">&#39;/register&#39;</span>, async (req, res) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> { username, password } <span style="color: #333333">=</span> req.body;
  <span style="color: #008800; font-weight: bold">if</span> (username <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span> <span style="color: #333333">||</span> password <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span>) {
    <span style="color: #888888">// Malformed request body</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&quot;Username and password required&quot;</span>);
  }
  <span style="color: #008800; font-weight: bold">try</span> {
    <span style="color: #888888">// Create user in database</span>
    await createUser({ username, password });
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">200</span>).send(<span style="background-color: #fff0f0">&quot;User created&quot;</span>);
  } <span style="color: #008800; font-weight: bold">catch</span> {
    <span style="color: #888888">// Duplicate user</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&quot;User already exists&quot;</span>);
  }
});

<span style="color: #888888">// Endpoint for logging in an obtaining access token</span>
app.post(<span style="background-color: #fff0f0">&#39;/login&#39;</span>, async (req, res) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> { username, password } <span style="color: #333333">=</span> req.body;
  <span style="color: #008800; font-weight: bold">if</span> (username <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span> <span style="color: #333333">||</span> password <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span>) {
    <span style="color: #888888">// Malformed request body</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&#39;Username and password required&#39;</span>);
  }
  <span style="color: #008800; font-weight: bold">try</span> {
    <span style="color: #888888">// Get access token from logging in</span>
    <span style="color: #008800; font-weight: bold">const</span> token <span style="color: #333333">=</span> await login({ username, password });
    <span style="color: #888888">// Send it back to user</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">200</span>).send({ token });
  } <span style="color: #008800; font-weight: bold">catch</span> (e) {
    <span style="color: #008800; font-weight: bold">if</span> (e <span style="color: #008800; font-weight: bold">instanceof</span> IncorrectPassword) {
      <span style="color: #888888">// User provided incorrect password</span>
      <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&#39;Incorrect password&#39;</span>);
    }
    <span style="color: #008800; font-weight: bold">if</span> (e <span style="color: #008800; font-weight: bold">instanceof</span> UserNotFound) {
      <span style="color: #888888">// User does not exist</span>
      <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&#39;User not found&#39;</span>);
    }
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&#39;Invalid credentials&#39;</span>);
  }
})

<span style="color: #888888">// Endpoint for updating a user&#39;s high score</span>
app.post(<span style="background-color: #fff0f0">&#39;/high-score&#39;</span>, validateToken, async (req, res) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">const</span> { score } <span style="color: #333333">=</span> req.body;
  <span style="color: #008800; font-weight: bold">if</span> (score <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span>) {
    <span style="color: #888888">// Malformed request body</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&quot;Score required&quot;</span>);
  }
  <span style="color: #008800; font-weight: bold">try</span> {
    <span style="color: #888888">// Set high score in database</span>
    await setHighScore(res.locals.username, score);
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">200</span>).send(<span style="background-color: #fff0f0">&quot;High score updated&quot;</span>);
  } <span style="color: #008800; font-weight: bold">catch</span> {
    <span style="color: #888888">// Only occurs when user not found in database</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&quot;User not found&quot;</span>);
  }
});

<span style="color: #888888">// Endpoint for retrieving a user&#39;s high score</span>
app.get(<span style="background-color: #fff0f0">&#39;/high-score&#39;</span>, validateToken, async (req, res) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">try</span> {
    <span style="color: #888888">// Get score of user associated with access token</span>
    <span style="color: #008800; font-weight: bold">const</span> score <span style="color: #333333">=</span> await highScore(res.locals.username);
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">200</span>).send({ score })
  } <span style="color: #008800; font-weight: bold">catch</span> {
    <span style="color: #888888">// User not found</span>
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&quot;User not found&quot;</span>);
  }
});

app.get(<span style="background-color: #fff0f0">&#39;/high-score/rankings&#39;</span>, async (req, res) <span style="color: #333333">=&gt;</span> {
  <span style="color: #008800; font-weight: bold">try</span> {
    <span style="color: #008800; font-weight: bold">const</span> { limit } <span style="color: #333333">=</span> req.query;
    <span style="color: #008800; font-weight: bold">if</span> (limit <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span>) {
      <span style="color: #888888">// Send back all high scores</span>
      <span style="color: #008800; font-weight: bold">const</span> scores <span style="color: #333333">=</span> await highScores();
      <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">200</span>).send({ scores })
    }
    <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #008800; font-weight: bold">typeof</span> limit <span style="color: #333333">!==</span> <span style="background-color: #fff0f0">&#39;string&#39;</span>) {
      <span style="color: #888888">// limit has incorrect type</span>
      <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&#39;Limit has incorrect type&#39;</span>);
    }
    <span style="color: #888888">// Parse string given representing limit</span>
    <span style="color: #008800; font-weight: bold">const</span> max <span style="color: #333333">=</span> <span style="color: #007020">parseInt</span>(limit, <span style="color: #0000DD; font-weight: bold">10</span>);
    <span style="color: #008800; font-weight: bold">if</span> (<span style="color: #007020">Number</span>.<span style="color: #007020">isNaN</span>(max)) {
      <span style="color: #888888">// limit string does not represent number</span>
      <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">400</span>).send(<span style="background-color: #fff0f0">&#39;Cannot parse limit&#39;</span>);
    }
    <span style="color: #008800; font-weight: bold">const</span> scores <span style="color: #333333">=</span> await highScores(max);
    <span style="color: #008800; font-weight: bold">return</span> res.status(<span style="color: #0000DD; font-weight: bold">200</span>).send({ scores })
  } <span style="color: #008800; font-weight: bold">catch</span> {
    <span style="color: #008800; font-weight: bold">return</span> res.sendStatus(<span style="color: #0000DD; font-weight: bold">400</span>);
  }
});

<span style="color: #888888">/** The port the app will accept requests from */</span>
<span style="color: #008800; font-weight: bold">const</span> port <span style="color: #333333">=</span> process.env.PORT <span style="color: #333333">||</span> <span style="color: #0000DD; font-weight: bold">8080</span>;

app.listen(port, () <span style="color: #333333">=&gt;</span> {
  console.log(<span style="color: #FF0000; background-color: #FFAAAA">`</span>Listening on port ${port}<span style="color: #FF0000; background-color: #FFAAAA">`</span>);
})
</pre>
            </td>
          </tr>
        </table>
      </div>
      <h3>game.py</h3>
      <!-- HTML generated using hilite.me -->
      <div
        style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
        <pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pygame</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">enum</span> <span style="color: #008800; font-weight: bold">import</span> Enum
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">enum</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">random</span>


<span style="color: #888888"># Represents a cardinal direction</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Dir</span>(Enum):
    UP <span style="color: #333333">=</span> enum<span style="color: #333333">.</span>auto()
    DOWN <span style="color: #333333">=</span> enum<span style="color: #333333">.</span>auto()
    LEFT <span style="color: #333333">=</span> enum<span style="color: #333333">.</span>auto()
    RIGHT <span style="color: #333333">=</span> enum<span style="color: #333333">.</span>auto()

    <span style="color: #888888"># Calculates the angle to 180 degrees, in units of 90 degrees</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">angle_to_left</span>(<span style="color: #007020">self</span>):
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span> <span style="color: #333333">==</span> Dir<span style="color: #333333">.</span>UP:
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">1</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span> <span style="color: #333333">==</span> Dir<span style="color: #333333">.</span>DOWN:
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span> <span style="color: #333333">==</span> Dir<span style="color: #333333">.</span>LEFT:
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span> <span style="color: #333333">==</span> Dir<span style="color: #333333">.</span>RIGHT:
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">2</span>


<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">create_board</span>(side):
    <span style="color: #008800; font-weight: bold">return</span> np<span style="color: #333333">.</span>zeros((side, side), <span style="color: #007020">int</span>)

<span style="color: #888888"># Filter out the zero elements of a given array, leaving only the nonzero elements</span>


<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">filter_nonzeros</span>(arr):
    nonzeros <span style="color: #333333">=</span> []
    <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> arr:
        <span style="color: #008800; font-weight: bold">if</span> i <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">0</span>:
            nonzeros<span style="color: #333333">.</span>append(i)
    <span style="color: #008800; font-weight: bold">return</span> nonzeros


<span style="color: #888888"># Shifts a row left according to 2048 semantics and returns the resulting row</span>
<span style="color: #888888"># Empty tiles are represented with zeros</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">shift_row</span>(row):
    nonzeros <span style="color: #333333">=</span> filter_nonzeros(row)
    shifted_tiles <span style="color: #333333">=</span> []
    i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">while</span> i <span style="color: #333333">&lt;</span> <span style="color: #007020">len</span>(nonzeros):
        right_tile <span style="color: #333333">=</span> nonzeros[i]
        left_tile <span style="color: #333333">=</span> nonzeros[i <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">1</span>]
        <span style="color: #888888"># Try to combine the tiles at index i - 1 and i</span>
        <span style="color: #008800; font-weight: bold">if</span> left_tile <span style="color: #333333">==</span> right_tile:
            <span style="color: #888888"># If we can merge the tiles, add a doubled tile to the result</span>
            <span style="color: #888888"># and bump the index by 2 to consider the next unmerged tile</span>
            shifted_tiles<span style="color: #333333">.</span>append(left_tile <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>)
            i <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">2</span>
        <span style="color: #008800; font-weight: bold">else</span>:
            <span style="color: #888888"># Otherwise, we cannot merge the tile at index i,</span>
            <span style="color: #888888"># so we append it to the result unchanged. We bump the counter by</span>
            <span style="color: #888888"># 1 to try to merge the tiles at indices i and i + 1</span>
            shifted_tiles<span style="color: #333333">.</span>append(left_tile)
            i <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #888888"># If we did not merge the second to last and last tile, we have to add the</span>
    <span style="color: #888888"># last tile unchanged to the result</span>
    <span style="color: #008800; font-weight: bold">if</span> i <span style="color: #333333">==</span> <span style="color: #007020">len</span>(nonzeros):
        shifted_tiles<span style="color: #333333">.</span>append(nonzeros[<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>])
    <span style="color: #888888"># We pad the &quot;empty space&quot; created by merging and shifting tiles with empty tiles</span>
    pad_length <span style="color: #333333">=</span> <span style="color: #007020">len</span>(row) <span style="color: #333333">-</span> <span style="color: #007020">len</span>(shifted_tiles)
    <span style="color: #008800; font-weight: bold">return</span> np<span style="color: #333333">.</span>pad(np<span style="color: #333333">.</span>array(shifted_tiles, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>int64), (<span style="color: #0000DD; font-weight: bold">0</span>, pad_length), <span style="background-color: #fff0f0">&#39;constant&#39;</span>)

<span style="color: #888888"># Shifts a matrix left according to the 2048 semantics</span>


<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">shift_left</span>(matrix):
    <span style="color: #008800; font-weight: bold">return</span> np<span style="color: #333333">.</span>array([shift_row(row) <span style="color: #008800; font-weight: bold">for</span> row <span style="color: #000000; font-weight: bold">in</span> matrix])

<span style="color: #888888"># Shifts a matrix in a given direction according to the 2048 semantics</span>


<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">shift</span>(matrix, <span style="color: #007020">dir</span>):
    <span style="color: #888888"># Rotate the matrix so we shift left, and then rotate back</span>
    angle <span style="color: #333333">=</span> <span style="color: #007020">dir</span><span style="color: #333333">.</span>angle_to_left()
    <span style="color: #008800; font-weight: bold">return</span> np<span style="color: #333333">.</span>rot90(shift_left(np<span style="color: #333333">.</span>rot90(matrix, angle)), <span style="color: #333333">-</span>angle)


<span style="color: #888888"># RGB of colors to be used in the game</span>
white <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>)
black <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>)
gray <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">169</span>, <span style="color: #0000DD; font-weight: bold">169</span>, <span style="color: #0000DD; font-weight: bold">169</span>)
tile_empty <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">204</span>, <span style="color: #0000DD; font-weight: bold">192</span>, <span style="color: #0000DD; font-weight: bold">179</span>)
tile_2 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">238</span>, <span style="color: #0000DD; font-weight: bold">228</span>, <span style="color: #0000DD; font-weight: bold">218</span>)
tile_4 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">237</span>, <span style="color: #0000DD; font-weight: bold">224</span>, <span style="color: #0000DD; font-weight: bold">200</span>)
tile_8 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">242</span>, <span style="color: #0000DD; font-weight: bold">177</span>, <span style="color: #0000DD; font-weight: bold">121</span>)
tile_16 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">245</span>, <span style="color: #0000DD; font-weight: bold">149</span>, <span style="color: #0000DD; font-weight: bold">99</span>)
tile_32 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">246</span>, <span style="color: #0000DD; font-weight: bold">124</span>, <span style="color: #0000DD; font-weight: bold">95</span>)
tile_64 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">246</span>, <span style="color: #0000DD; font-weight: bold">94</span>, <span style="color: #0000DD; font-weight: bold">59</span>)
tile_128 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">237</span>, <span style="color: #0000DD; font-weight: bold">207</span>, <span style="color: #0000DD; font-weight: bold">114</span>)
tile_256 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">237</span>, <span style="color: #0000DD; font-weight: bold">204</span>, <span style="color: #0000DD; font-weight: bold">97</span>)
tile_512 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">237</span>, <span style="color: #0000DD; font-weight: bold">200</span>, <span style="color: #0000DD; font-weight: bold">80</span>)
tile_1024 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">237</span>, <span style="color: #0000DD; font-weight: bold">197</span>, <span style="color: #0000DD; font-weight: bold">63</span>)
tile_2048 <span style="color: #333333">=</span> (<span style="color: #0000DD; font-weight: bold">237</span>, <span style="color: #0000DD; font-weight: bold">194</span>, <span style="color: #0000DD; font-weight: bold">46</span>)

<span style="color: #888888"># The index of the colors in here correspond to the tile value exponent</span>
tile_colors <span style="color: #333333">=</span> [tile_empty, tile_2, tile_4, tile_8, tile_16, tile_32,
               tile_64, tile_128, tile_256, tile_512, tile_1024, tile_2048]


<span style="color: #888888"># Represents a 2048 board</span>
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Board</span>:
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__init__</span>(<span style="color: #007020">self</span>, arg<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">4</span>):
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">isinstance</span>(arg, <span style="color: #007020">int</span>):
            <span style="color: #888888"># initalize with side length</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>side <span style="color: #333333">=</span> arg
            <span style="color: #007020">self</span><span style="color: #333333">.</span>board <span style="color: #333333">=</span> create_board(<span style="color: #007020">self</span><span style="color: #333333">.</span>side)
        <span style="color: #008800; font-weight: bold">else</span>:
            <span style="color: #888888"># initialize with matrix</span>
            <span style="color: #007020">self</span><span style="color: #333333">.</span>side <span style="color: #333333">=</span> <span style="color: #007020">len</span>(arg)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>board <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(arg)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>score <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">__str__</span>(<span style="color: #007020">self</span>):
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">str</span>(np<span style="color: #333333">.</span>array([[<span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #008800; font-weight: bold">if</span> i <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">**</span> i <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> row] <span style="color: #008800; font-weight: bold">for</span> row <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>board]))

    <span style="color: #888888"># Calculates the score difference of the new board and past board</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">score_difference</span>(<span style="color: #007020">self</span>, board):
        tiles <span style="color: #333333">=</span> <span style="color: #007020">list</span>(board<span style="color: #333333">.</span>flatten())
        <span style="color: #008800; font-weight: bold">for</span> tile <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>board<span style="color: #333333">.</span>flatten():
            <span style="color: #008800; font-weight: bold">if</span> tile <span style="color: #000000; font-weight: bold">in</span> tiles:
                tiles<span style="color: #333333">.</span>remove(tile)
        score <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        <span style="color: #008800; font-weight: bold">for</span> tile <span style="color: #000000; font-weight: bold">in</span> tiles:
            <span style="color: #008800; font-weight: bold">if</span> tile <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">0</span>:
                score <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #333333">&lt;&lt;</span> tile
        <span style="color: #008800; font-weight: bold">return</span> score

    <span style="color: #888888"># Shift this 2048 board in place</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">shift</span>(<span style="color: #007020">self</span>, <span style="color: #007020">dir</span>: Dir):
        shifted <span style="color: #333333">=</span> shift(<span style="color: #007020">self</span><span style="color: #333333">.</span>board, <span style="color: #007020">dir</span>)
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> np<span style="color: #333333">.</span>array_equiv(shifted, <span style="color: #007020">self</span><span style="color: #333333">.</span>board):
            <span style="color: #007020">self</span><span style="color: #333333">.</span>score <span style="color: #333333">+=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>score_difference(shifted)
            <span style="color: #007020">self</span><span style="color: #333333">.</span>board <span style="color: #333333">=</span> shifted
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">True</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">False</span>

    <span style="color: #888888"># Returns if the board can shift in direction dir or not</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">can_shift</span>(<span style="color: #007020">self</span>, <span style="color: #007020">dir</span>):
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #000000; font-weight: bold">not</span> np<span style="color: #333333">.</span>array_equal(<span style="color: #007020">self</span><span style="color: #333333">.</span>board, shift(<span style="color: #007020">self</span><span style="color: #333333">.</span>board, <span style="color: #007020">dir</span>))

    <span style="color: #888888"># Returns the exponent (2**exponent) of the tile at location (i, j)</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">at</span>(<span style="color: #007020">self</span>, i, j):
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>board[i][j]

    <span style="color: #888888"># Add a random tile (2 or 4) in random empty spot to the board</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">add_tile</span>(<span style="color: #007020">self</span>):
        i <span style="color: #333333">=</span> random<span style="color: #333333">.</span>randrange(<span style="color: #007020">self</span><span style="color: #333333">.</span>side)
        j <span style="color: #333333">=</span> random<span style="color: #333333">.</span>randrange(<span style="color: #007020">self</span><span style="color: #333333">.</span>side)
        v <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #008800; font-weight: bold">if</span> random<span style="color: #333333">.</span>randint(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #0000DD; font-weight: bold">2</span>
        <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>at(i, j) <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">0</span>:
            i <span style="color: #333333">=</span> random<span style="color: #333333">.</span>randrange(<span style="color: #007020">self</span><span style="color: #333333">.</span>side)
            j <span style="color: #333333">=</span> random<span style="color: #333333">.</span>randrange(<span style="color: #007020">self</span><span style="color: #333333">.</span>side)
        <span style="color: #007020">self</span><span style="color: #333333">.</span>board[i][j] <span style="color: #333333">=</span> v

    <span style="color: #888888"># Returns the pygame font based on the windows height and size proportion</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">get_font</span>(<span style="color: #007020">self</span>, height, size_proportion):
        font_size <span style="color: #333333">=</span> height <span style="color: #333333">//</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>side <span style="color: #333333">//</span> size_proportion
        <span style="color: #008800; font-weight: bold">return</span> pygame<span style="color: #333333">.</span>font<span style="color: #333333">.</span>Font(<span style="color: #007020">None</span>, font_size)

    <span style="color: #888888"># Draws the current state of the board</span>
    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">draw</span>(<span style="color: #007020">self</span>, screen, width, height):
        <span style="color: #888888"># font setup</span>
        font <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>get_font(height, <span style="color: #0000DD; font-weight: bold">2</span>)

        <span style="color: #888888"># calculates tile height and width based window size</span>
        tile_height <span style="color: #333333">=</span> height <span style="color: #333333">//</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>side <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>)
        tile_width <span style="color: #333333">=</span> width <span style="color: #333333">//</span> (<span style="color: #007020">self</span><span style="color: #333333">.</span>side <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>)
        <span style="color: #888888"># how much to shift the text in the tiles</span>
        to_shift <span style="color: #333333">=</span> tile_width <span style="color: #333333">//</span> <span style="color: #0000DD; font-weight: bold">2</span>

        <span style="color: #888888"># loop through each spot in the board matrix</span>
        <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>side):
            <span style="color: #008800; font-weight: bold">for</span> j <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>side):
                <span style="color: #888888"># the tile exponent (2**exponent is the value of the tile)</span>
                tile_exponent <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>at(i, j)
                <span style="color: #888888"># the x, y coordinates of the tile on the screen</span>
                tileX <span style="color: #333333">=</span> j <span style="color: #333333">*</span> tile_width <span style="color: #333333">+</span> to_shift
                tileY <span style="color: #333333">=</span> i <span style="color: #333333">*</span> tile_height <span style="color: #333333">+</span> to_shift <span style="color: #333333">//</span> <span style="color: #0000DD; font-weight: bold">2</span>
                <span style="color: #888888"># tile and text color</span>
                tile_color <span style="color: #333333">=</span> tile_colors[tile_exponent]
                text_color <span style="color: #333333">=</span> white
                <span style="color: #888888"># change text color to be more visible if tile has value 2 or 4</span>
                <span style="color: #008800; font-weight: bold">if</span> tile_color <span style="color: #333333">==</span> tile_2 <span style="color: #000000; font-weight: bold">or</span> tile_color <span style="color: #333333">==</span> tile_4:
                    text_color <span style="color: #333333">=</span> gray
                <span style="color: #888888"># draw tile</span>
                tile <span style="color: #333333">=</span> pygame<span style="color: #333333">.</span>draw<span style="color: #333333">.</span>rect(screen, tile_color, (tileX <span style="color: #333333">-</span> to_shift,
                                                             tileY <span style="color: #333333">-</span> to_shift <span style="color: #333333">//</span> <span style="color: #0000DD; font-weight: bold">2</span>, tile_width, tile_height))

                tile_number <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">**</span> tile_exponent
                <span style="color: #888888"># if no number, then text is &quot;&quot;]</span>
                tile_text <span style="color: #333333">=</span> font<span style="color: #333333">.</span>render(<span style="color: #007020">str</span>(tile_number), <span style="color: #007020">True</span>,
                                        text_color) <span style="color: #008800; font-weight: bold">if</span> tile_number <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #008800; font-weight: bold">else</span> font<span style="color: #333333">.</span>render(<span style="background-color: #fff0f0">&quot;&quot;</span>, <span style="color: #007020">True</span>,
                                                                                         text_color)
                tile_rect <span style="color: #333333">=</span> tile_text<span style="color: #333333">.</span>get_rect(centerx<span style="color: #333333">=</span>tileX, y<span style="color: #333333">=</span>tileY)
                screen<span style="color: #333333">.</span>blit(tile_text, tile_rect)
        <span style="color: #888888"># Check if game is ended (lost or won)</span>
        game_status <span style="color: #333333">=</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>end()
        <span style="color: #008800; font-weight: bold">if</span> game_status[<span style="color: #0000DD; font-weight: bold">0</span>]:
            <span style="color: #888888"># Display Lost or Won message</span>
            status_text <span style="color: #333333">=</span> font<span style="color: #333333">.</span>render(game_status[<span style="color: #0000DD; font-weight: bold">1</span>], <span style="color: #007020">True</span>, text_color)
            status_rect <span style="color: #333333">=</span> status_text<span style="color: #333333">.</span>get_rect(
                centerx<span style="color: #333333">=</span>width <span style="color: #333333">//</span> <span style="color: #0000DD; font-weight: bold">2</span>, y<span style="color: #333333">=</span>height <span style="color: #333333">-</span> to_shift)
            screen<span style="color: #333333">.</span>blit(status_text, status_rect)

        <span style="color: #888888"># draw vertical and horizontal separating lines</span>
        <span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">2</span>):
            <span style="color: #008800; font-weight: bold">for</span> j <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #007020">self</span><span style="color: #333333">.</span>side <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span>):
                <span style="color: #008800; font-weight: bold">if</span> i <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>:  <span style="color: #888888"># horizontal</span>
                    pygame<span style="color: #333333">.</span>draw<span style="color: #333333">.</span>line(
                        screen, white, (<span style="color: #0000DD; font-weight: bold">0</span>, j <span style="color: #333333">*</span> tile_height), (tile_width <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>side, j <span style="color: #333333">*</span> tile_height))
                <span style="color: #008800; font-weight: bold">else</span>:  <span style="color: #888888"># vertical</span>
                    pygame<span style="color: #333333">.</span>draw<span style="color: #333333">.</span>line(
                        screen, white, (j <span style="color: #333333">*</span> tile_width, <span style="color: #0000DD; font-weight: bold">0</span>), (j <span style="color: #333333">*</span> tile_width, tile_height <span style="color: #333333">*</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>side))

    <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">end</span>(<span style="color: #007020">self</span>):
        <span style="color: #888888"># check if 2048 tile has been reached</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #0000DD; font-weight: bold">11</span> <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>board:
            <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">True</span>, <span style="background-color: #fff0f0">&quot;YOU WON!!&quot;</span>)

        <span style="color: #888888"># check if shifting the board in any direction results in no change</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>can_shift(Dir<span style="color: #333333">.</span>UP) <span style="color: #000000; font-weight: bold">or</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>can_shift(Dir<span style="color: #333333">.</span>DOWN) <span style="color: #000000; font-weight: bold">or</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>can_shift(Dir<span style="color: #333333">.</span>LEFT) <span style="color: #000000; font-weight: bold">or</span> <span style="color: #007020">self</span><span style="color: #333333">.</span>can_shift(Dir<span style="color: #333333">.</span>RIGHT):
            <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">False</span>, <span style="background-color: #fff0f0">&quot;&quot;</span>)
        <span style="color: #008800; font-weight: bold">else</span>:
            <span style="color: #008800; font-weight: bold">return</span> (<span style="color: #007020">True</span>, <span style="background-color: #fff0f0">&quot;You Lost&quot;</span>)
</pre>
      </div>

    </div>

  </div><!-- /.container -->




  <!-- Bootstrap core JavaScript
    ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
  <script src="dist/js/bootstrap.min.js"></script>
  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->
</body>

</html>